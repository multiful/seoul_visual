# app.py
import json
import io
import numpy as np
import pandas as pd
import geopandas as gpd
import altair as alt
import plotly.express as px
import matplotlib.pyplot as plt
import streamlit as st

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ê¸°ë³¸ ì„¤ì •
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
st.set_page_config(layout="wide", page_title="íë ´ í™˜ì ëŒ€ì‹œë³´ë“œ", page_icon="ğŸ«")
alt.themes.enable("dark")
st.title("ğŸ« ìš”ì–‘ê¸°ê´€ ì†Œì¬ì§€ ê¸°ì¤€ íë ´ í™˜ì ëŒ€ì‹œë³´ë“œ")

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ë°ì´í„° ë¡œë”©
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
with st.sidebar:
    st.header("ë°ì´í„° ì„ íƒ")
    st.caption("ë°˜ë“œì‹œ ì•„ë˜ ì»¬ëŸ¼ì´ ìˆì–´ì•¼ í•©ë‹ˆë‹¤.\n"
               "- ìš”ì–‘ê¸°ê´€ì†Œì¬ì§€ (1~5 ì½”ë“œ)\n- ì„±ë³„ (1/2 ë˜ëŠ” ë‚¨/ì—¬)\n"
               "ì„ íƒ: (ìˆìœ¼ë©´ ìë™ í™œìš©) ë‚˜ì´/ì—°ë ¹, ìš”ì–‘ê¸°ê´€ì¢…ë³„\n")
    data_file = st.file_uploader("íë ´ ë°ì´í„°(.csv)", type=["csv"])
    geo_path = st.text_input("í–‰ì •êµ¬ì—­ GeoJSON ê²½ë¡œ", "bnd_sigungu_2024_4326.geojson")
    st.divider()

# íë ´ ë°ì´í„° CSV ê²½ë¡œ ì§€ì • (ì•ì—ì„œ ì €ì¥í•œ íŒŒì¼)
data_file = "pneumonia_data.csv"

# ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
try:
    df_raw = pd.read_csv(data_file, encoding="utf-8-sig")
    st.success("íë ´ ë°ì´í„° CSV íŒŒì¼ì„ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤ âœ…")
except FileNotFoundError:
    st.error("íë ´ ë°ì´í„° CSV íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ê²½ë¡œë¥¼ í™•ì¸í•˜ì„¸ìš”.")
    st.stop()

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ì „ì²˜ë¦¬ & ê³µí†µ ë§¤í•‘
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
df = df_raw.copy()

# ê¶Œì—­ ë§¤í•‘ (ìš”ì–‘ê¸°ê´€ì†Œì¬ì§€: 1~5)
REGION_MAP = {
    1: "ì„œìš¸,ì¸ì²œ",
    2: "ê²½ê¸°,ê°•ì›",
    3: "ì¶©ì²­ê¶Œ(ì¶©ë¶, ì¶©ë‚¨, ì„¸ì¢…, ëŒ€ì „)",
    4: "ì „ë¼ê¶Œ(ì „ë¶, ì „ë‚¨, ê´‘ì£¼)",
    5: "ê²½ìƒê¶Œ(ê²½ë¶, ê²½ë‚¨, ë¶€ì‚°, ëŒ€êµ¬, ìš¸ì‚°, ì œì£¼)"
}
VALID_REGIONS = list(REGION_MAP.values())

# ì„±ë³„ ë§¤í•‘
def map_sex(s):
    s = str(s).strip()
    if s in ("1", "ë‚¨", "male", "Male", "M", "m"):
        return "ë‚¨"
    if s in ("2", "ì—¬", "female", "Female", "F", "f"):
        return "ì—¬"
    return np.nan

df["ìš”ì–‘ê¸°ê´€ì†Œì¬ì§€_num"] = pd.to_numeric(df["ìš”ì–‘ê¸°ê´€ì†Œì¬ì§€"], errors="coerce")
df["ê¶Œì—­"] = df["ìš”ì–‘ê¸°ê´€ì†Œì¬ì§€_num"].map(REGION_MAP)
df["ì„±ë³„_label"] = df["ì„±ë³„"].map(map_sex)

# ë¶„ì„ ëŒ€ìƒë§Œ ë‚¨ê¸°ê¸°
df = df[df["ê¶Œì—­"].isin(VALID_REGIONS)].copy()

# ì‹œë„ìˆ˜(ê¶Œì—­ë³„) - í‘œì¤€í™”ìš©
REGION_SIDO_N = {
    "ì„œìš¸,ì¸ì²œ": 2,
    "ê²½ê¸°,ê°•ì›": 2,
    "ì¶©ì²­ê¶Œ(ì¶©ë¶, ì¶©ë‚¨, ì„¸ì¢…, ëŒ€ì „)": 4,
    "ì „ë¼ê¶Œ(ì „ë¶, ì „ë‚¨, ê´‘ì£¼)": 3,
    "ê²½ìƒê¶Œ(ê²½ë¶, ê²½ë‚¨, ë¶€ì‚°, ëŒ€êµ¬, ìš¸ì‚°, ì œì£¼)": 6,
}

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ì‚¬ì´ë“œë°” í•„í„°
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
with st.sidebar:
    st.header("í•„í„°")
    # ì„ íƒì ìœ¼ë¡œ ìš”ì–‘ê¸°ê´€ì¢…ë³„, ì—°ë ¹ í•„í„°ê°€ ìˆìœ¼ë©´ ì œê³µ
    if "ìš”ì–‘ê¸°ê´€ì¢…ë³„" in df.columns:
        sel_types = st.multiselect("ìš”ì–‘ê¸°ê´€ì¢…ë³„", sorted(df["ìš”ì–‘ê¸°ê´€ì¢…ë³„"].astype(str).unique()), [])
        if sel_types:
            df = df[df["ìš”ì–‘ê¸°ê´€ì¢…ë³„"].astype(str).isin(sel_types)]
    if "ë‚˜ì´" in df.columns:
        age_min, age_max = int(df["ë‚˜ì´"].min()), int(df["ë‚˜ì´"].max())
        age_range = st.slider("ë‚˜ì´ ë²”ìœ„", min_value=age_min, max_value=age_max, value=(age_min, age_max))
        df = df[(df["ë‚˜ì´"] >= age_range[0]) & (df["ë‚˜ì´"] <= age_range[1])]
    st.caption(f"í˜„ì¬ ë ˆì½”ë“œ ìˆ˜: {len(df):,}")

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# íƒ­ êµ¬ì„±
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
tab_main, tab_gender, tab_map, tab_corr = st.tabs(["ë©”ì¸", "ì„±ë³„ ë¶„ì„", "ì§€ë„(ê¶Œì—­)", "ê³ ë ¹ì¸êµ¬ë¹„ìœ¨ ìƒê´€"])

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ë©”ì¸: ê¶Œì—­ í‘œì¤€í™”(ì‹œë„ìˆ˜ ë³´ì •) ë§‰ëŒ€ê·¸ë˜í”„
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
with tab_main:
    st.subheader("ê¶Œì—­ë³„ ë¶„í¬ â€” ì‹œë„ìˆ˜ ë³´ì •(í‘œì¤€í™”) ê¸°ì¤€")

    raw_counts = df["ê¶Œì—­"].value_counts().reindex(VALID_REGIONS, fill_value=0)
    std_counts = raw_counts.astype(float).div(pd.Series(REGION_SIDO_N))
    std_pct = (std_counts / std_counts.sum() * 100).round(2)

    plot_df = std_pct.reset_index()
    plot_df.columns = ["ê¶Œì—­", "ì‹œë„ìˆ˜ ë³´ì • ë¹„ìœ¨(%)"]
    plot_df = plot_df.sort_values("ì‹œë„ìˆ˜ ë³´ì • ë¹„ìœ¨(%)", ascending=False)

    chart = (
        alt.Chart(plot_df)
        .mark_bar()
        .encode(
            x=alt.X("ì‹œë„ìˆ˜ ë³´ì • ë¹„ìœ¨(%):Q", title="ë¹„ìœ¨(%)"),
            y=alt.Y("ê¶Œì—­:N", sort="-x"),
            tooltip=["ê¶Œì—­:N", "ì‹œë„ìˆ˜ ë³´ì • ë¹„ìœ¨(%):Q"],
            color=alt.Color("ì‹œë„ìˆ˜ ë³´ì • ë¹„ìœ¨(%):Q", scale=alt.Scale(scheme="reds"))
        )
        .properties(height=320)
    )
    text = (
        alt.Chart(plot_df)
        .mark_text(align="left", baseline="middle", dx=4)
        .encode(x="ì‹œë„ìˆ˜ ë³´ì • ë¹„ìœ¨(%):Q", y="ê¶Œì—­:N", text="ì‹œë„ìˆ˜ ë³´ì • ë¹„ìœ¨(%):Q")
    )
    st.altair_chart(chart + text, use_container_width=True)

    with st.expander("í‘œ ë³´ê¸°"):
        st.dataframe(plot_df, use_container_width=True)

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ì„±ë³„ ë¶„ì„: ì „ì²´ ì„±ë³„ ë¹„ìœ¨ + ê¶Œì—­Ã—ì„±ë³„ ìŠ¤í”Œë¦¿
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
with tab_gender:
    st.subheader("ì„±ë³„ ë¶„í¬(ì „ì²´) ë° ê¶Œì—­ë³„ ì„±ë³„ ë¹„êµ")

    # ì „ì²´ ì„±ë³„ ë¹„ìœ¨
    gender = df[df["ì„±ë³„_label"].notna()]["ì„±ë³„_label"]
    g_pct = (gender.value_counts(normalize=True) * 100).reindex(["ë‚¨", "ì—¬"]).fillna(0).round(1)
    g_df = g_pct.reset_index()
    g_df.columns = ["ì„±ë³„", "ë¹„ìœ¨(%)"]

    c1, c2 = st.columns([1, 2])
    with c1:
        pie = px.pie(g_df, values="ë¹„ìœ¨(%)", names="ì„±ë³„", color="ì„±ë³„",
                     color_discrete_map={"ë‚¨": "#66c2a5", "ì—¬": "#fc8d62"},
                     hole=0.4, title="ì„±ë³„ ë¶„í¬(%)")
        pie.update_traces(textinfo="label+percent")
        st.plotly_chart(pie, use_container_width=True)

    with c2:
        # ê¶Œì—­ Ã— ì„±ë³„ ë¹„ìœ¨(ê¶Œì—­ ë‚´ ì •ê·œí™”)
        cross = (
            df[df["ì„±ë³„_label"].notna()]
            .groupby(["ê¶Œì—­", "ì„±ë³„_label"]).size()
            .groupby(level=0).apply(lambda x: x / x.sum() * 100)
            .rename("ë¹„ìœ¨(%)").reset_index()
        )
        bar = (
            alt.Chart(cross)
            .mark_bar()
            .encode(
                x=alt.X("ë¹„ìœ¨(%):Q", title="ë¹„ìœ¨(%)"),
                y=alt.Y("ê¶Œì—­:N", sort="-x"),
                color=alt.Color("ì„±ë³„_label:N", title="ì„±ë³„",
                                scale=alt.Scale(domain=["ë‚¨", "ì—¬"], range=["#66c2a5", "#fc8d62"])),
                tooltip=["ê¶Œì—­:N", "ì„±ë³„_label:N", "ë¹„ìœ¨(%):Q"]
            )
            .properties(title="ê¶Œì—­ë³„ ì„±ë³„ ë¹„ìœ¨(ê¶Œì—­ ë‚´ %)", height=320)
        )
        st.altair_chart(bar, use_container_width=True)

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ì§€ë„: ê¶Œì—­ ë‹¨ìœ„ Choropleth (ì‹œë„ìˆ˜ ë³´ì • ë¹„ìœ¨ ê¸°ì¤€)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
with tab_map:
    st.subheader("ê¶Œì—­ë³„ Choropleth â€” ì‹œë„ìˆ˜ ë³´ì • ë¹„ìœ¨(%)")

    # GeoJSON ë¡œë“œ & ê¶Œì—­ ë§¤í•‘(ì‹œêµ°êµ¬ì½”ë“œ prefix â†’ ê¶Œì—­)
    try:
        gdf = gpd.read_file(geo_path)  # columns: SIGUNGU_CD, SIGUNGU_NM, geometry ...
    except Exception as e:
        st.error(f"GeoJSONì„ ì½ëŠ” ì¤‘ ì˜¤ë¥˜: {e}")
        st.stop()

    xmin, ymin, xmax, ymax = gdf.total_bounds
    gdf["SIDO2"] = gdf["SIGUNGU_CD"].astype(str).str[:2]
    CODE_TO_REGION = {
        # ì„œìš¸Â·ì¸ì²œ
        "11": "ì„œìš¸,ì¸ì²œ", "23": "ì„œìš¸,ì¸ì²œ",
        # ê²½ê¸°Â·ê°•ì›
        "31": "ê²½ê¸°,ê°•ì›", "32": "ê²½ê¸°,ê°•ì›",
        # ì¶©ì²­ê¶Œ
        "33": "ì¶©ì²­ê¶Œ(ì¶©ë¶, ì¶©ë‚¨, ì„¸ì¢…, ëŒ€ì „)", "34": "ì¶©ì²­ê¶Œ(ì¶©ë¶, ì¶©ë‚¨, ì„¸ì¢…, ëŒ€ì „)",
        "29": "ì¶©ì²­ê¶Œ(ì¶©ë¶, ì¶©ë‚¨, ì„¸ì¢…, ëŒ€ì „)", "25": "ì¶©ì²­ê¶Œ(ì¶©ë¶, ì¶©ë‚¨, ì„¸ì¢…, ëŒ€ì „)",
        # ì „ë¼ê¶Œ
        "35": "ì „ë¼ê¶Œ(ì „ë¶, ì „ë‚¨, ê´‘ì£¼)", "36": "ì „ë¼ê¶Œ(ì „ë¶, ì „ë‚¨, ê´‘ì£¼)", "24": "ì „ë¼ê¶Œ(ì „ë¶, ì „ë‚¨, ê´‘ì£¼)",
        # ê²½ìƒê¶Œ
        "21": "ê²½ìƒê¶Œ(ê²½ë¶, ê²½ë‚¨, ë¶€ì‚°, ëŒ€êµ¬, ìš¸ì‚°, ì œì£¼)", "22": "ê²½ìƒê¶Œ(ê²½ë¶, ê²½ë‚¨, ë¶€ì‚°, ëŒ€êµ¬, ìš¸ì‚°, ì œì£¼)",
        "26": "ê²½ìƒê¶Œ(ê²½ë¶, ê²½ë‚¨, ë¶€ì‚°, ëŒ€êµ¬, ìš¸ì‚°, ì œì£¼)", "37": "ê²½ìƒê¶Œ(ê²½ë¶, ê²½ë‚¨, ë¶€ì‚°, ëŒ€êµ¬, ìš¸ì‚°, ì œì£¼)",
        "38": "ê²½ìƒê¶Œ(ê²½ë¶, ê²½ë‚¨, ë¶€ì‚°, ëŒ€êµ¬, ìš¸ì‚°, ì œì£¼)", "39": "ê²½ìƒê¶Œ(ê²½ë¶, ê²½ë‚¨, ë¶€ì‚°, ëŒ€êµ¬, ìš¸ì‚°, ì œì£¼)",
    }
    gdf["ê¶Œì—­"] = gdf["SIDO2"].map(CODE_TO_REGION)

    # ì‹œë„ìˆ˜ ë³´ì • ë¹„ìœ¨ ë°ì´í„° ì¤€ë¹„
    std_pct_df = std_pct.reset_index()
    std_pct_df.columns = ["ê¶Œì—­", "ë¹„ìœ¨(%)"]

    # ê¶Œì—­ dissolve í›„ ë³‘í•©
    region_gdf = gdf.dissolve(by="ê¶Œì—­", as_index=False)
    region_gdf = region_gdf.merge(std_pct_df, on="ê¶Œì—­", how="left").fillna({"ë¹„ìœ¨(%)": 0})

    # Matplotlibë¡œ í‘œì‹œ
    fig, ax = plt.subplots(figsize=(8, 10))
    region_gdf.plot(ax=ax, column="ë¹„ìœ¨(%)", cmap="Reds", legend=True,
                    edgecolor="black", linewidth=0.6,
                    legend_kwds={"shrink": 0.75, "orientation": "vertical"})
    gdf.boundary.plot(ax=ax, color="black", linewidth=0.2, alpha=0.5)
    ax.set_xlim(xmin, xmax); ax.set_ylim(ymin, ymax)
    ax.set_aspect("equal", adjustable="box"); ax.margins(0)
    ax.set_title("ìš”ì–‘ê¸°ê´€ ì†Œì¬ì§€ ê¶Œì—­ë³„ ë¹„ìœ¨(ì‹œë„ìˆ˜ ë³´ì •)", fontsize=13)
    ax.axis("off")
    st.pyplot(fig, use_container_width=True)

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ê³ ë ¹ì¸êµ¬ë¹„ìœ¨ ìƒê´€: íŒŒì¼ ì—…ë¡œë“œ â†’ ê¶Œì—­/ì‹œë„ ì§‘ê³„ì™€ ë¹„êµ
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
with tab_corr:
    st.subheader("ê³ ë ¹ì¸êµ¬ë¹„ìœ¨ê³¼ì˜ ê´€ê³„ (ì„ íƒ)")
    st.caption("ì‹œë„ ë‹¨ìœ„ ê³ ë ¹ì¸êµ¬ë¹„ìœ¨ íŒŒì¼(ì˜ˆ: í†µê³„ì²­ KOSIS) ì—…ë¡œë“œ ì‹œ, "
               "ê¶Œì—­/ì‹œë„ í™˜ì ë¶„í¬ì™€ ë¹„êµ ì§€í‘œë¥¼ ê³„ì‚°í•©ë‹ˆë‹¤.")
    uploaded_xlsx = st.file_uploader("ê³ ë ¹ì¸êµ¬ë¹„ìœ¨ ì—‘ì…€(.xlsx)", type=["xlsx"])

    if uploaded_xlsx:
        try:
            # ì‹œë„ë³„(í–‰ì •êµ¬ì—­ë³„(1)) + ìµœì‹  ì—°ë„ ì»¬ëŸ¼ ì¶”ì¶œ ê°€ì •
            xls = pd.ExcelFile(uploaded_xlsx)
            sheet = [s for s in xls.sheet_names if "ë°ì´í„°" in s or "data" in s.lower()]
            sheet = sheet[0] if sheet else xls.sheet_names[0]
            age_df = pd.read_excel(uploaded_xlsx, sheet_name=sheet)

            # ì‹œë„ëª… ì»¬ëŸ¼ ì¶”ì •
            sido_col = [c for c in age_df.columns if "í–‰ì •êµ¬ì—­" in str(c)][0]
            # ìµœì‹  ì—°ë„ % ì»¬ëŸ¼ ì¶”ì • (ìˆ«ìí˜• ì¤‘ ìµœëŒ€ ì—°ë„)
            year_cols = [c for c in age_df.columns if isinstance(c, (int, np.integer))]
            latest_year = max(year_cols)
            age_sido = age_df[[sido_col, latest_year]].rename(
                columns={sido_col: "ì‹œë„", latest_year: "ê³ ë ¹ì¸êµ¬ë¹„ìœ¨(%)"}
            )

            # dfì—ì„œ ì‹œë„ ë‹¨ìœ„ê°€ ì—†ìœ¼ë¯€ë¡œ ê¶Œì—­â†’ì‹œë„ ë§¤í•‘ìœ¼ë¡œ ë¶„ì‚° (ê°€ì¤‘ì¹˜ ì—†ì´ í‰ê· )
            REGION_TO_SIDO = {
                "ì„œìš¸,ì¸ì²œ": ["ì„œìš¸íŠ¹ë³„ì‹œ", "ì¸ì²œê´‘ì—­ì‹œ"],
                "ê²½ê¸°,ê°•ì›": ["ê²½ê¸°ë„", "ê°•ì›íŠ¹ë³„ìì¹˜ë„", "ê°•ì›ë„"],
                "ì¶©ì²­ê¶Œ(ì¶©ë¶, ì¶©ë‚¨, ì„¸ì¢…, ëŒ€ì „)": ["ì¶©ì²­ë¶ë„", "ì¶©ì²­ë‚¨ë„", "ì„¸ì¢…íŠ¹ë³„ìì¹˜ì‹œ", "ëŒ€ì „ê´‘ì—­ì‹œ"],
                "ì „ë¼ê¶Œ(ì „ë¶, ì „ë‚¨, ê´‘ì£¼)": ["ì „ë¶íŠ¹ë³„ìì¹˜ë„", "ì „ë¼ë¶ë„", "ì „ë¼ë‚¨ë„", "ê´‘ì£¼ê´‘ì—­ì‹œ"],
                "ê²½ìƒê¶Œ(ê²½ë¶, ê²½ë‚¨, ë¶€ì‚°, ëŒ€êµ¬, ìš¸ì‚°, ì œì£¼)": ["ê²½ìƒë¶ë„", "ê²½ìƒë‚¨ë„", "ë¶€ì‚°ê´‘ì—­ì‹œ", "ëŒ€êµ¬ê´‘ì—­ì‹œ", "ìš¸ì‚°ê´‘ì—­ì‹œ", "ì œì£¼íŠ¹ë³„ìì¹˜ë„"],
            }

            # ê¶Œì—­ë³„ í‘œì¤€í™” ë¹„ìœ¨ì„ ì‹œë„ì— ë³µì œ í›„ ì‹œë„ í‰ê·  ì‚°ì¶œ
            expand_rows = []
            for reg, pct in std_pct.items():
                for s in REGION_TO_SIDO.get(reg, []):
                    expand_rows.append({"ì‹œë„": s, "í‘œì¤€í™”ë¹„ìœ¨(%)": pct})
            reg_to_sido_df = pd.DataFrame(expand_rows)

            merged = pd.merge(reg_to_sido_df, age_sido, on="ì‹œë„", how="inner")
            # ì‹œë„ë³„ í‰ê· (ê¶Œì—­ ë³µìˆ˜ ì‹œë„ ë§¤í•‘ ë³´ì •)
            merged = merged.groupby("ì‹œë„", as_index=False).mean(numeric_only=True)

            st.write("ë¯¸ë¦¬ë³´ê¸°")
            st.dataframe(merged)

            # ì‚°ì ë„ + ìƒê´€ê³„ìˆ˜
            corr = merged[["í‘œì¤€í™”ë¹„ìœ¨(%)", "ê³ ë ¹ì¸êµ¬ë¹„ìœ¨(%)"]].corr().iloc[0, 1]
            st.markdown(f"**ìƒê´€ê³„ìˆ˜ (ê¶Œì—­ í‘œì¤€í™”ë¹„ìœ¨ vs ì‹œë„ ê³ ë ¹ì¸êµ¬ë¹„ìœ¨)**: `{corr:.2f}`")

            sc = alt.Chart(merged).mark_circle(size=120).encode(
                x=alt.X("ê³ ë ¹ì¸êµ¬ë¹„ìœ¨(%):Q"),
                y=alt.Y("í‘œì¤€í™”ë¹„ìœ¨(%):Q"),
                tooltip=["ì‹œë„", "ê³ ë ¹ì¸êµ¬ë¹„ìœ¨(%)", "í‘œì¤€í™”ë¹„ìœ¨(%)"],
                color=alt.value("#e74c3c")
            )
            reg_line = sc.transform_regression("ê³ ë ¹ì¸êµ¬ë¹„ìœ¨(%)", "í‘œì¤€í™”ë¹„ìœ¨(%)").mark_line(color="#f39c12")
            st.altair_chart(sc + reg_line, use_container_width=True)

        except Exception as e:
            st.error(f"íŒŒì¼ í•´ì„ ì¤‘ ì˜¤ë¥˜: {e}")
            st.stop()

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# í’‹ë…¸íŠ¸
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
st.caption("â“’ Respiratory Rehab / Pneumonia Insights â€” ê¶Œì—­ì€ ìš”ì–‘ê¸°ê´€ ì†Œì¬ì§€ ê¸°ì¤€, "
           "ê¶Œì—­ ë§‰ëŒ€ê·¸ë˜í”„ëŠ” ì‹œë„ìˆ˜ ë³´ì •(ì‹œë„ë‹¹ í‰ê· ) í›„ 100% ì •ê·œí™”í•œ ë¹„ìœ¨ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.")
